<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Chat</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <script src="{{ url_for('static', filename='js/socket.io.latest.js') }}"></script>

    <div class="container-fluid h-100">
        <div class="row justify-content-center h-100">
            <div class="col-md-8 col-xl-6 chat">
                <div class="card">
                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight">
                            <div class="user_info">
                                <span>Serveur Général</span>
                            </div>
                            <div class="logout">
                                <a href="main" class="btn btn-secondary">Retour</a>
                                <a href="{{ url_for('logout') }}" class="btn btn-danger">Se déconnecter</a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body msg_card_body" id="messages">
                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <textarea id="messageContent" class="form-control type_msg" placeholder="Tapez votre message..."></textarea>
                            <div class="input-group-append">
                                <span class="input-group-text send_btn" id="submit"><i class="fas fa-location-arrow"></i></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    
    <script type="text/javascript">
        var socket = io();

        document.addEventListener("DOMContentLoaded", function () {
            var btn = document.getElementById("submit");
            var input = document.getElementById("messageContent");
            var messages = document.getElementById("messages");

            function sendMessage() {
                var message = input.value.trim();
                if (message) {

                    // easter egg...
                    var htmlTagPattern = /<\/?[a-z][\s\S]*>/i;                
                    if (htmlTagPattern.test(message)) {
                        alert("Why you try this ;)");
                    }


                    var today = new Date();
                    var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds() + " (" + Intl.DateTimeFormat().resolvedOptions().timeZone + ")";
                    socket.emit("message", message + " - " + time);
                    input.value = "";
                }
            }

            btn.addEventListener("click", function (event) {
                event.preventDefault();
                sendMessage();
            });

            input.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    sendMessage();
                }
            });

            socket.on("server response", function (data) {
                var newMessage = document.createElement("div");
                newMessage.innerHTML = data;
                messages.appendChild(newMessage);
                newMessage.scrollIntoView({ behavior: "smooth" });
            });
        });
    </script>


</body>

</html>
